name: C++ CI

on:
  push:
    branches: [main, develop, feature/CI]
  pull_request:
    branches: [main, develop]

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          sudo apt install cmake \
            build-essential \
            libtool \
            autoconf \
            unzip wget clang \
            software-properties-common \
            lsb-release \
            libudev-dev \
            libopenal-dev \
            libvorbis-dev \
            libflac-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libfreetype-dev -y

      - name: Get Cmake 3.28
        run: |
          sudo apt clean all
          sudo apt remove --purge --auto-remove cmake -y
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /etc/apt/trusted.gpg.d/kitware.gpg >/dev/null
          sudo apt-add-repository "deb https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" -y
          sudo apt update -y
          sudo apt install kitware-archive-keyring -y
          sudo rm /etc/apt/trusted.gpg.d/kitware.gpg
          sudo apt update -y
          sudo apt install cmake -y

      - name: Build with CMake and Clang
        run: |
          mkdir build && cd build
          cmake ..
          make -j$(nproc)

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Build with CMake and MSVC
        run: |
          mkdir build && cd build
          cmake -G "Visual Studio 17" -A x64 ..
          cmake --build . --config Release

      - name: Create project archive
        run: |
          mkdir release
          Compress-Archive -Path r-type.exe, assets, *.dll -DestinationPath r-type.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: r-type release
          path: r-type.zip

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Release
          release_name: Release ${{ github.run_number }}
          draft: false
          prerelease: false
          body: "New version of the Rtype"
          assets: r-type.zip
